@model IEnumerable<ERA_BMS.Models.Culvert>

<br />
@{
    string textColor = "text-success";
    if (ViewBag.StatusMessage.Contains("error"))
    {
        textColor = "text-danger";
    }
}

<p id="statusmessage" class="@textColor" style="font-size: 15px">@ViewBag.StatusMessage</p>

<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title panel-info"><b>Modify</b> Culvert Information (Segment: <b>@ViewBag.SegmentName</b>, Section: <b>@ViewBag.SectionName</b>, District: <b>@ViewBag.DistrictName</b>)</h3>
    </div>

    <div class="panel-body">
        <table class="table table-striped table-condensed table-responsive display compact hover" id="culverts">
            <thead>
                <tr>
                    <th>
                        @Html.DisplayNameFor(model => model.CulvertNo)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.RevisedCulvertNo)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.Segment.SegmentName)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.SubRoute.SubRouteName)
                    </th>
                    <th>
                        @if (User.IsInRole("Admin"))
                        {
                            <span>Edit</span>
                        }
                    </th>
                    <th>Inventory</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            <span class="CulvertNo" name="@item.CulvertId">@item.CulvertNo</span>
                        </td>
                        <td>
                            <span class="RevisedCulvertNo" name="@item.CulvertId">@item.RevisedCulvertNo</span>
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Segment.SegmentName)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.SubRoute.SubRouteName)
                        </td>
                        <td>
                            @if (User.IsInRole("Admin"))
                            {
                                @Html.ActionLink(" ", "Edit", new { id = item.CulvertId }, new { @class = "glyphicon glyphicon-edit", @data_toggle = "tooltip", title = "Edit" })
                            }
                        </td>
                        <td align="center">
                            <a href="@Url.Action("Index", "CulvertInventory", new { id = item.CulvertId })" target="_blank" class="glyphicon glyphicon-new-window" data-toggle="tooltip" title="Go to Inventory" style="font-size: 14px"></a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="panel-footer">
        <h3 class="panel-title">Total No. of Culverts: <b>@Model.Count()</b></h3>
    </div>
</div>

<script>
    $(document).ready(function () {
        makeCulvertNoEditable();
        makeNewCulvertIdEditable();

        $('#culverts').dataTable({
            paging: true,
            pageLength: 15,
            bLengthChange: true,
            scrollY: 400,

            searching: true,
            select: true,
            dom: 'lBfrtip',
            //order: [[1, "asc"]] // sort by the second column (CulvertNo)
            buttons: [
                { extend: 'copy', className: 'btn btn-sm btn-primary' },
                { extend: 'excel', className: 'btn btn-sm btn-primary', text: 'Export Excel' },
                { extend: 'pdf', className: 'btn btn-sm btn-primary', text: 'Export PDF' },
                { extend: 'print', className: 'btn btn-sm btn-primary' }
            ]
        });

        // A function that makes "CulvertNo" editable
        function makeCulvertNoEditable() {
            $(".CulvertNo").each(function () {
                $(this).editable("/Culverts/UpdateCulvertNo", {
                    callback: function (value, settings) {
                        var obj = JSON.parse(value);
                        $(this).html(obj.value);

                        var msg = obj.Message;

                        $('#statusmessage').removeClass("text-success");
                        $('#statusmessage').removeClass("text-danger");
                        if (msg.toLowerCase().includes("error"))
                            $('#statusmessage').addClass("text-danger");
                        else
                            $('#statusmessage').addClass("text-success");
                        $('#statusmessage').text(obj.Message);
                    },
                    submitdata: function () {
                        return {
                            // Pass parameters to "UpdateCulvertNo" action in "Culverts" controller action
                            id: $(this).attr("name"),
                            origvalue: this.revert,
                        };
                    },
                    before: function () {
                        // clear the status message
                        $('#statusmessage').text("");
                    },
                    before: function () {
                        // clear the status message
                        $('#statusmessage').text("");
                    },
                    tooltip: 'Click or Tap to edit...',
                    placeholder: '-',
                    indicator: 'Saving...',
                    label: "** Be careful!",
                    cssclass: "redtextbox",
                    size: 15
                });
            });
        }

        // A function that makes "RevisedCulvertNo" editable
        function makeNewCulvertIdEditable() {
            $(".RevisedCulvertNo").each(function () {
                $(this).editable("/Culverts/UpdateNewCulvertId", {
                    callback: function (value, settings) {
                        var obj = JSON.parse(value);
                        $(this).html(obj.value);

                        var msg = obj.Message;

                        $('#statusmessage').removeClass("text-success");
                        $('#statusmessage').removeClass("text-danger");
                        if (msg.toLowerCase().includes("error"))
                            $('#statusmessage').addClass("text-danger");
                        else
                            $('#statusmessage').addClass("text-success");
                        $('#statusmessage').text(obj.Message);
                    },
                    submitdata: function () {
                        return {
                            // Pass parameters to "UpdateNewCulvertId" action in "Culverts" controller action
                            id: $(this).attr("name"),
                            origvalue: this.revert,
                        };
                    },
                    before: function () {
                        // clear the status message
                        $('#statusmessage').text("");
                    },
                    before: function () {
                        // clear the status message
                        $('#statusmessage').text("");
                    },
                    tooltip: 'Click or Tap to edit...',
                    placeholder: '-',
                    indicator: 'Saving...',
                    label: "** Be careful!",
                    cssclass: "redtextbox",
                    size: 15
                });
            });
        }
    });
</script>
